---
title: "Resolución Actividad 2, Secuenciación y Ómicas de Próxima Generación, Máster Bioinformática UNIR (2025). \n Análisis de expresión diferencial de genes relacionados con la obesidad mediante RNA-seq"
author: "Oriana Batista Ceballos"
date: "2025-12-21"
output:
  html_document:
    theme: readable
    toc: true
    toc_depth: 3
    toc_float: true
    highlight: textmate
  pdf_document:
    toc: true
    toc_depth: '3'
  word_document:
    toc: true
    toc_depth: '3'
---

# I. Introducción

*  En este se introduce el script 2 con la visualización de la expresión diferencial génica a través de un gráfico Heatmap. 

```{r, message=FALSE, warning=FALSE, eval=TRUE} 
# CARGAR LIBRERÍAS
library(tximport)
library(DESeq2)
library(ggplot2)
library(pheatmap)
library(dplyr)

# 1. CONFIGURACIÓN DE ARCHIVOS Y METADATOS
samples <- c("AbrahamSimpson", "HomerSimpson", "MargeSimpson", "PattyBouvier", "SelmaBouvier")
files <- file.path("Salmon", samples, "quant.sf")
names(files) <- samples

# 2. RESUMEN DE CUANTIFICACIÓN (Parte A)
tx2gene <- read.table("Transcrito_a_Gen.tsv", header = TRUE)
txi <- tximport(files, type = "salmon", tx2gene = tx2gene, countsFromAbundance = "no")
counts_matrix <- round(txi$counts)  # Enteros
write.csv(counts_matrix, "resumen_cuantificacion.csv")

# 3. PREPARAR METADATOS
colData <- data.frame(
  sample = samples,
  grupo = c("obeso1", "obeso1", "obeso2", "obeso2", "obeso2")
)
rownames(colData) <- samples

# 4. ANÁLISIS DIFERENCIAL CON DESeq2 (Parte B)
dds <- DESeqDataSetFromMatrix(
  countData = counts_matrix,
  colData = colData,
  design = ~ grupo
)

# Añadir esta verificación
print(paste("Número de genes:", nrow(dds)))
print(paste("Número de muestras:", ncol(dds)))

dds <- DESeq(dds, minReplicatesForReplace = Inf)  # Sin filtrado por simulación
res <- results(dds, contrast = c("grupo", "obeso1", "obeso2"))


# Heatmap - CORRECCIÓN: Usar varianceStabilizingTransformation en lugar de vst
# Para pocos genes (37), usar rlog o vst con blind=TRUE
if (nrow(dds) < 1000) {
  vsd <- rlog(dds, blind = FALSE)
} else {
  vsd <- varianceStabilizingTransformation(dds, blind = FALSE)
}

# Seleccionar top genes (máximo 20 o todos si hay menos)
n_top <- min(20, nrow(res))
top_genes <- rownames(res)[order(res$padj, na.last = NA)][1:n_top]

# Filtrar genes que no tengan NA en padj
valid_genes <- !is.na(res$padj)
if (sum(valid_genes) > 0) {
  top_genes <- rownames(res)[order(res$padj, na.last = NA)][1:min(20, sum(valid_genes))]
  heatmap_data <- assay(vsd)[top_genes, ]
  
  # Crear anotaciones para el heatmap
  annotation_col <- data.frame(Grupo = colData$grupo)
  rownames(annotation_col) <- colnames(heatmap_data)
  
  pheatmap(heatmap_data,
           scale = "row",
           main = paste("Heatmap - Top", length(top_genes), "genes diferenciales"),
           cluster_rows = TRUE,
           cluster_cols = TRUE,
           annotation_col = annotation_col,
           show_rownames = TRUE,
           fontsize_row = 8)
} else {
  print("No hay genes con valores de padj no-NA para el heatmap")
  
  # Heatmap alternativo con todos los genes
  heatmap_data <- assay(vsd)
  annotation_col <- data.frame(Grupo = colData$grupo)
  rownames(annotation_col) <- colnames(heatmap_data)
  
  pheatmap(heatmap_data,
           scale = "row",
           main = "Heatmap - Todos los genes (37)",
           cluster_rows = TRUE,
           cluster_cols = TRUE,
           annotation_col = annotation_col,
           show_rownames = TRUE,
           fontsize_row = 6)
}

# 6. RESUMEN DE RESULTADOS
print("Resumen de resultados diferenciales:")
print(summary(res))

# Guardar resultados
write.csv(as.data.frame(res), "resultados_diferenciales.csv")

# Mostrar los genes más significativos
print("Top 10 genes más significativos:")
print(head(res[order(res$padj), ], 10))

```
